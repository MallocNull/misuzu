{% extends 'manage/users/master.twig' %}
{% from 'macros.twig' import container_title %}
{% from 'manage/macros.twig' import permissions_table %}
{% from '_layout/input.twig' import input_csrf, input_text, input_checkbox, input_file %}

{% set site_link = '/profile.php?u=' ~ view_user.user_id %}

{% block manage_content %}
    {% if can_manage_users %}
        <form method="post" enctype="multipart/form-data" action=""{% if view_user is defined %} style="{{ view_user.user_colour|html_colour('--accent-colour') }}"{% endif %}>
            {{ input_csrf('users_edit') }}

            <div class="container">
                {{ container_title('Viewing ' ~ view_user.username ~ ' (' ~ view_user.user_id ~ ')') }}

                <label class="form__label">
                    <div class="form__label__text">Username</div>
                    <div class="form__label__input">
                        {{ input_text('user[username]', '', view_user.username, 'text', '', true, {'maxlength':16}) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">E-mail address</div>
                    <div class="form__label__input">
                        {{ input_text('user[email]', '', view_user.email, 'text', '', true, {'maxlength':255}) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Title</div>
                    <div class="form__label__input">
                        {{ input_text('user[title]', '', view_user.user_title, 'text', '', false, {'maxlength':64}) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Joined</div>
                    <div class="form__label__input">
                        {{ input_text('', '', view_user.created_at) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Last online</div>
                    <div class="form__label__input">
                        {{ input_text('', '', view_user.last_seen) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Register IP</div>
                    <div class="form__label__input">
                        {{ input_text('', '', view_user.register_ip_decoded) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Last IP</div>
                    <div class="form__label__input">
                        {{ input_text('', '', view_user.last_ip_decoded) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Country</div>
                    <div class="form__label__input">
                        {{ input_text('user[country]', '', view_user.user_country, 'text', 'XX', true, {'maxlength':2,'minlength':2}) }}
                    </div>
                </label>
            </div>

            <div class="container">
                {{ container_title('Avatar') }}

                <label class="form__label">
                    <div class="form__label__text">New Avatar</div>
                    <div class="form__label__input">
                        {{ input_file('avatar[file]') }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Delete Avatar</div>
                    <div class="form__label__input">
                        {{ input_checkbox('avatar[delete]') }}
                    </div>
                </label>
            </div>

            <div class="container">
                {{ container_title('Password') }}

                <label class="form__label">
                    <div class="form__label__text">New Password</div>
                    <div class="form__label__input">
                        {{ input_text('password[new]', '', '', 'password') }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Confirm Password</div>
                    <div class="form__label__input">
                        {{ input_text('password[confirm]', '', '', 'password') }}
                    </div>
                </label>
            </div>

            <div class="container">
                {{ container_title('Colour') }}

                {% set colour_is_defined = view_user is defined and view_user.user_colour is not null and not view_user.user_colour|colour_get_inherit %}

                <label class="form__label">
                    <div class="form__label__text">Custom Colour</div>
                    <div class="form__label__input">
                        {{ input_checkbox('colour[enable]', '', colour_is_defined) }}
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Red</div>
                    <div class="form__label__input">
                        <input class="input input--number" type="number" value="{{ colour_is_defined ? view_user.user_colour|colour_get_red : '0' }}" min="0" max="255" name="colour[red]">
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Green</div>
                    <div class="form__label__input">
                        <input class="input input--number" type="number" value="{{ colour_is_defined ? view_user.user_colour|colour_get_green : '0' }}" min="0" max="255" name="colour[green]">
                    </div>
                </label>

                <label class="form__label">
                    <div class="form__label__text">Blue</div>
                    <div class="form__label__input">
                        <input class="input input--number" type="number" value="{{ colour_is_defined ? view_user.user_colour|colour_get_blue : '0' }}" min="0" max="255" name="colour[blue]">
                    </div>
                </label>
            </div>

            {% if can_manage_perms %}
                <div class="container">
                    {{ container_title('Permissions') }}
                    {{ permissions_table(permissions) }}
                </div>
            {% endif %}

            <button class="input__button">Update</button>
        </form>
    {% endif %}

    {% if can_manage_users %}
        {% if has_roles|length > 0 %}
            <form method="post" action="" class="container">
                {{ container_title('Manage Roles') }}

                <div class="container__content">
                    {{ input_csrf('users_edit') }}

                    <label class="form__label">
                        <div class="form__label__text">Has Roles</div>
                        <div class="form__label__input">
                            <select name="manage_roles[role]" class="input__select">
                                {% for role in has_roles %}
                                    <option value="{{ role.role_id }}"{% if role.role_id == view_user.display_role %} selected{% endif %}>
                                        {{ role.role_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>

                    <button class="input__button" name="manage_roles[mode]" value="display">Set Display</button>
                    <button class="input__button" name="manage_roles[mode]" value="remove">Remove</button>
                </div>
            </form>
        {% endif %}

        {% if available_roles|length > 0 %}
            <form method="post" action="" class="container">
                {{ container_title('Add role') }}

                <div class="container__content">
                    <label class="form__label">
                        <div class="form__label__text">Available Roles</div>
                        <div class="form__label__input">
                            <select name="add_role[role]" class="input__select">
                                {% for role in available_roles %}
                                    <option value="{{ role.role_id }}">
                                        {{ role.role_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>

                    <button class="input__button" name="csrf" value="{{ csrf_token('users_edit') }}">Add</button>
                </div>
            </form>
        {% endif %}
    {% endif %}
{% endblock %}
