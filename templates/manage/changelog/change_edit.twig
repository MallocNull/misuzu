{% extends 'manage/changelog/master.twig' %}
{% from 'macros.twig' import container_title %}
{% from '_layout/input.twig' import input_csrf, input_text %}

{% if edit_change is defined %}
    {% set site_link = '/changelog.php?c=' ~ edit_change.change_id %}
{% endif %}

{% block manage_content %}
    <div class="container">
        <form action="?v=change{{ edit_change is defined ? '&c=' ~ edit_change.change_id : '' }}" method="post">
            {{ input_csrf('changelog_add') }}

            {{ container_title(edit_change is defined ? 'Editing #' ~ edit_change.change_id : 'Adding a new change') }}

            <label class="form__label" style="width:100%">
                <div class="form__label__text">Log</div>
                <div class="form__label__input">
                    {{ input_text('change[log]', '', edit_change is defined ? edit_change.change_log : '', 'text', '', true, {'maxlength':255}) }}
                </div>
            </label>

            <label class="form__label" style="width:100%">
                <div class="form__label__text">Text</div>
                <div class="form__label__input">
                    <textarea class="input__textarea" name="change[text]" maxlength="65535">{{ edit_change is defined ? edit_change.change_text : '' }}</textarea>
                </div>
            </label>

            <label class="form__label">
                <div class="form__label__text">Action</div>
                <div class="form__label__input">
                    <select name="change[action]" class="input input--select">
                        {% for action in changelog_actions %}
                            <option value="{{ action.action_id }}"{% if edit_change is defined and action.action_id == edit_change.action_id %} selected{% endif %}>
                                {{ action.action_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </label>

            <label class="form__label">
                <div class="form__label__text">Contributor Id</div>
                <div class="form__label__input">
                    {{ input_text('change[user]', '', edit_change.user_id|default(current_user.user_id), 'number', '', false, {'min':1}) }}
                </div>
            </label>

            <label class="form__label">
                <div class="form__label__text">Created</div>
                <div class="form__label__input">
                    {{ input_text('change[created]', '', (edit_change is defined ? edit_change.change_created : ''|date('Y-m-d H:i:s')), 'text', '', true) }}
                </div>
            </label>

            <div>
                <button class="input__button">Save</button>
            </div>
        </form>

        {% if edit_change is defined %}
            {{ container_title('Tags') }}

            {% if edit_change_assigned_tags|length > 0 %}
                <form class="container" method="post" action="" style="display:inline-block">
                    <label class="form__label">
                        <div class="form__label__text">Assigned Tags</div>
                        <div class="form__label__input">
                            <select name="remove_tag" class="input input--select">
                                {% for tag in edit_change_assigned_tags %}
                                    <option value="{{ tag.tag_id }}">
                                        {{ tag.tag_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>

                    <div>
                        <button class="input__button" name="csrf" value="{{ csrf_token('changelog_add') }}">Remove</button>
                    </div>
                </form>
            {% endif %}

            {% if edit_change_available_tags|length > 0 %}
                <form class="container" method="post" action="" style="display:inline-block">
                    <label class="form__label">
                        <div class="form__label__text">Available Tags</div>
                        <div class="form__label__input">
                            <select name="add_tag" class="input input--select">
                                {% for tag in edit_change_available_tags %}
                                    <option value="{{ tag.tag_id }}">
                                        {{ tag.tag_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>

                    <div>
                        <button class="input__button" name="csrf" value="{{ csrf_token('changelog_add') }}">Add</button>
                    </div>
                </form>
            {% endif %}
        {% endif %}
    </div>
{% endblock %}
